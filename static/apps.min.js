var myApp = new Framework7({
	modalTitle: 'Dogefaucet',
	material: true
});
var mainView = myApp.addView('.view-main', {}),
	debug = false,
	countDownStop = false,
	deviceModel = (debug) ? "DEVICETEST" : null,
	deviceId = (debug) ? "DEVICETEST" : null,
	appVersion = 2,
	historyRender = false,
	admobid = {},
	trackId = "UA-110981255-1",
	timeoutAjax = 0,
	userMail = "notfounds",
	appealUrl = "https://goo.gl/forms/mXclvja8BRQWSZHX2",
	loginData = {address: null},
	$$ = Dom7;

var notifications = [
	"Be careful with bots, multiple accounts and automation we have a sensitive system.",
	"Pull down page to refresh data.",
	"Send email to us if any error",
	"Bad rate only make this app to be shutdown"
]

var appLang = "us";
var Profiles = {};

//dom element
var selectWithdrawalLevel	= $$('#selectWithdrawalLevel')
	earningValueDollar 		= $$('.earningValueDollar'),
	helpRefComission 		= $$('#helpRefComission'),
	earningRefValue 		= $$('.earningRefValue'),
	addressDogecoin 		= $$('.addressDogecoin'),
	referralCounter 		= $$('#referralCounter'),
	doWithdrawalButton 		= $$('#doWithdrawal'),
	refreshButton 			= $$('.refresh-data'),
	earningValue 			= $$('.earningValue'),
	tableEarning 			= $$('#tableEarning'),
	withdrawalView 			= $$('#withdrawal'),
	menuBottom				= $$('#menuBottom'),
	boxToggle				= $$('#box-toggle'),
	doClaimBonus 			= $$('#doClaimBonus'),
	notifDOM				= $$('#notifMessage')
	referralCode 			= $$('.referralCode'),
	helpRefCode 			= $$('#helpRefCode'),
	buttonCopy 				= $$('#buttonCopy'),
	buttonClaim 			= $$('#doClaim'),
	historyView 			= $$('#history'),
	faucetView 				= $$('#faucet'),
	wdMin					= $$('#wdMin'),
	wdMax					= $$('#wdMax'),
	wdFee 					= $$('#wdFee');

var wdLevel = {
	urgent: 5,
	high: 4,
	normal: 2
}

//baseurl api server
var baseUrl = (debug) ? "http://127.0.0.1:8084/api/v2/" : "http://192.168.0.20:8084/api/v2/";

/**
 * Logging
 * added Module to Log debugging Apps
 * 
 * @param {Object} options 
 */
var Logging = function(options) {

	this.options = options;
}
Logging.prototype.log = function(message) {
	if (debug) {
		if (this.options.type == "alert") {
			alert(message);
		} else {
			console.log(message);
		}
	}
}

var App = new Logging({
	type: 'console'
});
var Events = {
	onDeviceReady: function() {
		if (typeof device !== "undefined") {
			deviceId = device.uuid;
			deviceModel = device.model;
			
			if (device.isVirtual) {
				myApp.alert('Sorry, you are using detected using Virtual Device. Please using the real phone');

				return false;
			}

			var hashDevice = device;

			delete hashDevice.version;
			delete hashDevice.cordova;
			delete hashDevice.isVirtual;

			window.uuidDevice = CryptoJS.HmacSHA128(JSON.stringify(hashDevice), deviceId).toString();
		} 

		document.addEventListener("pause", Events.onAppPause, false);
		document.addEventListener("resume", Events.onAppResume, false);

		if( /(android)/i.test(navigator.userAgent) ) { // for android & amazon-fireos
			admobid = {
				banner: 'ca-app-pub-3848435382278815/4590007628',
				interstitial: 'ca-app-pub-3848435382278815/4934402806'
			};
		}

		// this will create a banner on startup
		if (typeof AdMob !== "undefined") {
			AdMob.createBanner( {
				adId: admobid.banner,
				position: AdMob.AD_POSITION.BOTTOM_CENTER,
				isTesting: false,
				overlap: false,
				offsetTopBar: false,
				bgColor: 'black'
			});
			AdMob.prepareInterstitial({
				adId: admobid.interstitial,
				autoShow:false
			});

			App.log("onDeviceReady - Admob created");
		}

		Events.onAppReady();

	    referralCode.click(function(e) {
	    	var profile = nyanStorage.get('userProfile');

	    	window.cordova.plugins.clipboard.copy(profile.referral, function() {
	    		Util.showNotif("Referral Code has been copy to clipboard", 3000);
	    	}, function() {
	    		Util.showNotif("Error while copy to clipboard", 3000);
	    	});
	    });

	    window.ga.startTrackerWithId(trackId, 30, function() {
			App.log('Google analytics is ready now');
			//the component is ready and you can call any method here
			window.ga.setUserId(device.uuid);
			window.ga.setAllowIDFACollection(true);
			window.ga.trackView('Apps');
        }, function(e) {
        	App.log('onDeviceReady - Error starting GoogleAnalytics');
        });

	    App.log("onDeviceReady event finish");
	},
	onLoad: function() {
		Util.seeTime();

		document.addEventListener("deviceready", Events.onDeviceReady);

		if (!window.cordova) {
			Events.onAppReady();
		}

		$$('#overlay-preloader').find("button").click(function() {
			$$('#overlay-preloader').find("h4").text("Loading...");
			$$('#overlay-preloader').find("button").hide();

			Events.onAppReady();
		});

		App.log("onLoad event finish");
	},
	onAjaxDetected: function(e) {
		if (e.detail.xhr.requestUrl.indexOf('autocomplete-languages.json') >= 0) {
			return;
		}
		if (e.type == "ajaxStart") {
			myApp.showIndicator();
		} else {
			myApp.hideIndicator();
		}
	},
	onAppReady: function() {
		App.log("onAppsReady Event start");
		Util.trackEvent('onPingRequest');

		var headers = {
			'x-app-version': appVersion.toString(),
			'x-device-id': deviceId,
			'x-device-model': deviceModel
		}
		deviceId = "DEVICETEST";
		var hmac = CryptoJS.HmacSHA256(JSON.stringify(headers), deviceId).toString();

		headers.Signature = "Barier " + hmac;
		headers.Nonce = Date.now();

		$$.ajax({
			url: baseUrl + 'ping/',
			method: 'POST',
			timeout: timeoutAjax,
			headers: headers,
			dataType: 'json',
			success: function(data) {
				App.log("onAppsReady Event - Ajax Complete");

				var userProfile = nyanStorage.get('userProfile');

				if (userProfile) {
					Util.setProfile(userProfile);
				} else {
					mainView.router.loadPage('login.html');
				}

				if (data.status) {
					wdMin.text(data.data.withdrawal.min);
					wdMax.text(data.data.withdrawal.max)

					nyanStorage.put('minWd', data.data.withdrawal.min);
					nyanStorage.put('maxWd', data.data.withdrawal.max);
					nyanStorage.put('dollar', data.data.price);
					nyanStorage.put('account', data.address);
					if (userProfile) {
						var newsId		 = nyanStorage.get('newsHash');
							Profiles 	 = userProfile; // global variable

						Util.renderPrice(data.data.price);
					}

					if (data.newsId !== newsId) {
						App.log("onAppReady Diff - " + data.newsId + " # " + newsId)
						   
						$$('i.icon-bars').html('<span class="badge bg-red">$</span>');
						$$('.newsListItem').append('<span class="badge bg-orange">NEW</span>');
					} else {
						App.log("onAppReady Event - news md5 same as before");
						
						$$('.newsListItem').find('span').remove();
						$$('i.icon-bars').find('span').remove();
					}

					setTimeout(function() {
						$$('#overlay-preloader').hide();

						if (!nyanStorage.get('newsShowCounter')) nyanStorage.put('newsShowCounter', 1);
						if (data.news.important.isAvailable && nyanStorage.get('newsShowCounter') <= 3) {
							myApp.alert(data.news.important.news, "Important News - " + nyanStorage.get('newsShowCounter') + "/3");

							nyanStorage.increment('newsShowCounter', 1);
						} else if (data.news.warning.isAvailable && nyanStorage.get('newsShowCounter') <= 3) {
							myApp.alert(data.news.warning.news, "Warning News - " + nyanStorage.get('newsShowCounter') + "/3");

							nyanStorage.increment('newsShowCounter', 1);
						}

					}, 1000);
				} else {
					setTimeout(function() {
						App.log("onAppReady Event - Error: " + data.toString());

						$$('#overlay-preloader').find('img#nyandev-logo').hide();
						$$('#overlay-preloader .sad').show();
						$$('#overlay-preloader').find("h4").text(data.message);
						$$('#overlay-preloader').find("button").show();
					}, 1000);
				}
			},
			error: function(data) {
				App.log("onAppReady Event - Error: ");
				App.log(data);

				$$('#overlay-preloader').find('img#nyandev-logo').hide();
				$$('#overlay-preloader .sad').show();
				$$('#overlay-preloader').find("h4").text("Sorry, we are can't connect to Server. Please try again later");
				$$('#overlay-preloader').find("button").show();
			}
		});

		/** Random notification on app
		 */
		notifDOM.text(notifications[Math.floor(Math.random() * notifications.length)])
	},
	onAppPause: function() {

		countDownStop = true;
	},
	onAppResume: function() {
		clearTimeout(nyanStorage.get('timeoutId'));
		Util.seeTime();
	},
	panel: {
		onOpen: function() {
			$$('.statusbar-overlay').addClass('with-panel-left');
		},
		onClose: function() {
			$$('.statusbar-overlay').removeClass('with-panel-left');
		}
	},
	button: {
		onClickBoxToggle: function() {
			boxToggle.toggleClass('active');
			menuBottom.toggleClass('active');
		},
		onClickClaim: function() {
			Util.trackEvent('onClaim');
			
			if ($$('#addressInput').val() !== "" && nyanStorage.get('claimTime') == null) {
				if (Profiles.status == "active") {
					var body = {
						deviceModel: deviceModel
					}
					var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), nyanStorage.get('apiKey')).toString()

					$$.ajax({
						url: baseUrl + "claim",
						method: 'POST',
						dataType: 'json',
						timeout: timeoutAjax,
						headers: {
							Signature: hmac,
							Nonce: Date.now(),
							Token: nyanStorage.get('apiKey'),
							Key: nyanStorage.get('key'),
							'x-app-version': appVersion,
							'x-device-id': deviceId
						},
						data: body,
						success: function (data, status, xhr) {
							if (data.status) {
								nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));
								nyanStorage.put('startClaim', Date.now());
								nyanStorage.put('claim', false);

								Util.countdown(4, 60);
								buttonClaim.addClass('disabled');

								earningValue.text((data.results.total * 1).toFixed(4) + " Ð");
								earningRefValue.text(data.results.refEarn + " Ð");
								Util.showNotif("+" + data.results.earn + " Ð", 3000);

								var profiles = nyanStorage.get('userProfile');
								profiles.amount = data.results.total;

								/**	
								 * Show Adds Pop up
								 */
								if (!debug) {
									AdMob.showInterstitial();
								}

								Profiles = profiles;
								nyanStorage.put('userProfile', profiles);

								Util.renderPrice();
								Util.trackEvent('onValidClaim');
							} else {
								try {
									window.ga.trackException('onClaimError', false);
								} catch(e) {
									App.log('onClaimError trackException error');
								}
								try	{
									if (data.message) {
										Util.showNotif("ERROR: " + data.message, 3000);

										if (data.message.indexOf('already claim')) {
											nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));
										}
										if (data.code == "ERRBANN") {
											Util.bannedCallback();
										}
									}
								} catch(e) {
									console.log(data.message);
								}
							}

						},
						error: Util.ajaxErrorCallback
					});	
				} else {
					Util.bannedCallback();
				}
			}

			App.log("onClickClaim event finish");
		},
		onClickWithdrawal: function() {
			Util.trackEvent('onRequestWithdrawal');

			if (Profiles.status == "active") {

				var amountToWd = ($$('#amountWd').val() * 1);
				var profile = nyanStorage.get('userProfile');
				var minWdVal = nyanStorage.get('minWd') * 1;
				var maxWdVal = nyanStorage.get('maxWd') * 1;
				var wdLevelSelected = selectWithdrawalLevel.text();
				var feeWdVal = wdLevel[wdLevelSelected.toLowerCase()];

				// do confirm
				if (amountToWd != 0) {
					var fromTimeout = false;
					var notifAdded = myApp.addNotification({
						message: "Confirm this action, auto cancel in 5s",
						button: {
							text: 'YES'
						},
						onClose: function() {
							if (!fromTimeout) {
								if (amountToWd > (profile.amount + feeWdVal)) {
									Util.showNotif("Amount withdrawal is larger than your earning amount!", 5000);
								} else if (amountToWd < minWdVal) {
									Util.showNotif("Amount withdrawal is smaller than Minimum Withdrawal!", 5000);
								} else if (amountToWd > maxWdVal) {
									Util.showNotif("Amount withdrawal is larger than Maximum Withdrawal!", 5000);
								} else {
									var body = {
										deviceModel: deviceModel,
										amount: amountToWd.toString(),
										level: wdLevelSelected
									}
									var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), nyanStorage.get('apiKey')).toString()
								
									$$.ajax({
										url: baseUrl + 'withdrawal/request',
										method: "POST",
										dataType: "json",
										timeout: timeoutAjax,
										headers: {
											Token: nyanStorage.get('apiKey'),
											Key: nyanStorage.get('key'),
											Signature: hmac,
											Nonce: Date.now(),
											'x-app-version': appVersion,
											'x-device-id': deviceId
										},
										data: body,
										success: function(res, status, xhr) {
											if (res.status) {
												nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));
												Util.showNotif("Withdrawal request has been added", 3000);
											} else {
												try	{
													nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));
													if (res.message) {
														myApp.alert("ERROR: " + res.message);
													}

													if (res.code == "ERRBANN") {
														Util.bannedCallback();
													}
												} catch(e) {
													console.log(res.message);
												}
											}
										},
										error: Util.ajaxErrorCallback
									});
								}
							}
						}
					});

					setTimeout(function() {
						fromTimeout = true;
						myApp.closeNotification(notifAdded);
					}, 5000);
				} else {
					Util.showNotif("Please fill amount of Doge you want to Withdrawal", 5000);
				}
			} else {

				Util.bannedCallback();
			}
		},
		onClickSelectWithdrawalLevel: function(e) {
			var _self = this;
			var options = [
				{
					text: 'Urgent (-5 Doge)',
					onClick: function() {
						$$(_self).text('Urgent');
						Events.button.onSelectWithdrawalLevelChange('urgent');
					}
				},
				{
					text: 'High (-4 Doge)',
					onClick: function() {
						$$(_self).text('High');
						Events.button.onSelectWithdrawalLevelChange('high');
					}
				},
				{
					text: 'Normal (-2 Doge)',
					onClick: function() {
						$$(_self).text('Normal');
						Events.button.onSelectWithdrawalLevelChange('normal');
					}
				}
			]

			myApp.actions(options);
		},
		onSelectWithdrawalLevelChange: function(wdLevelSelected) {
			var feeWdVal = wdLevel[wdLevelSelected];
			var timeoutId = true;
			
			if (timeoutId) {
				window.clearTimeout(timeoutId);

				timeoutId = window.setTimeout(function() {
					var thisVal = $$('#amountWd').val();
					$$('#estimatedReceived').val((thisVal * 1) - feeWdVal);
				}, 500);
			}
		}
	},
	page: {
		loginAccountDOM: "<li class=\"item-content\">\
			<div class=\"item-inner\">\
					<div class=\"card card-account\" data-address=\"{{ address }}\">\
						<div class='row'>\
							<div class=\"col-20\"><i class='icon icon-seat'></i></div>\
							<div class=\"col-80\">\
								<span class=\"address\">{{ shortAddress }}</span><br>\
								<span class=\"lastLogin\">Last login at {{ onLogin }}</span>\
							</div>\
					</div>\
				</div>\
			</div>\
		</li>",
		onInitLogin: function(page) {
			var accounts = nyanStorage.get('account');

			if (accounts.length != 0) {
				$$('#formContainer').addClass('hide');

				accounts.forEach(function(account) {
					account.shortAddress = account.address.substr(0, 8) + "__" + account.address.substr(-8, 8);

					elementTemplate = Template(Events.page.loginAccountDOM);
					elementRendered = elementTemplate(account); 	

					$$('#itemContainer').append(elementRendered);	
				});
			} else {
				$$('#listContainer').addClass('hide');
			}

			$$(page.container).find('#enterButton.inputForm').click(function () {
				Util.trackEvent('onLoginWithInput');

				var address = $$(page.container).find('input[name="address"]').val();
				var referral = $$(page.container).find('input[name="referral"]').val();

				if (address !== "") {
					var body = {
						address: address,
						referral: referral,
						deviceModel: deviceModel
					}
					var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), deviceId).toString();

					$$.ajax({
						url: baseUrl + "auth/",
						method: 'POST',
						dataType: 'json',
						timeout: timeoutAjax,
						headers: {
							Signature: hmac,
							Nonce: Date.now(),
							'x-app-version': appVersion,
							'x-device-id': deviceId
						},
						data: body,
						success: function (data, code, xhr) {
							myApp.hidePreloader();

							// Save
							if (data.status) {
								var etag = data.etag.split('.')[1].split('/')[0];

								nyanStorage.put('userProfile', data.results.user);
								nyanStorage.put('apiKey', data.results.apiKey);
								nyanStorage.put('key', etag);
								nyanStorage.put('data', data.data);
								nyanStorage.put('dollar', data.results.price);
								
								nyanStorage.put('minWd', data.withdrawal.min);
								nyanStorage.put('feeWd', data.withdrawal.fee);

								Profiles = data.results.user;

								Util.setProfile(data.results.user);

								mainView.router.back();
							} else {
								
								myApp.alert(data.message);
							}
						},
						error: Util.ajaxErrorCallback
					});
				} else {
					myApp.alert("Please fill Dogecoin address field");
				}
			});
			$$(page.container).find('#enterButton.selectForm').click(function () {
				Util.trackEvent('onLoginWithSelected');

				var address = loginData.address;

				if (address !== "") {
					var body = {
						address: address,
						referral: '',
						deviceModel: deviceModel
					}
					var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), deviceId).toString()
					$$.ajax({
						url: baseUrl + "auth/",
						method: 'POST',
						dataType: 'json',
						timeout: timeoutAjax,
						headers: {
							Signature: hmac,
							Nonce: Date.now(),
							'x-app-version': appVersion,
							'x-device-id': deviceId
						},
						data: body,
						success: function (data, code, xhr) {
							myApp.hidePreloader();

							// Save
							if (data.status) {
								var etag = data.etag.split('.')[1].split('/')[0];

								nyanStorage.put('userProfile', data.results.user);
								nyanStorage.put('apiKey', data.results.apiKey);
								nyanStorage.put('key', etag);
								nyanStorage.put('data', data.data);
								nyanStorage.put('dollar', data.results.price);
								
								nyanStorage.put('minWd', data.withdrawal.min);
								nyanStorage.put('feeWd', data.withdrawal.fee);

								Profiles = data.results.user;

								Util.setProfile(data.results.user);

								mainView.router.back();
							} else {
								
								myApp.alert(data.message);
							}
						},
						error: Util.ajaxErrorCallback
					});
				} else {
					myApp.alert("Please fill Dogecoin address field");
				}
			});

			nyanStorage.clear();
			nyanStorage.put('account', accounts);
		},
		onInitNews: function (page) {
			Util.trackEvent('onNewsInitialize');

			$$(page.container).find('#backButton').click(function () {
				mainView.router.back();
			});
			function render(news) {
				var newsWrapper = document.getElementById('newsWrapper'),
					elementString = "";

				newsWrapper.innerHTML = "";
				news.forEach(function(post) {
					post.post = btoa(JSON.stringify(post));
					elementString = "<li class='swipeout'>\
										<div class='swipeout-content'><a href='javascript:void(0)' data-news='{{ post }}' class='item-link item-content link-news'>\
											<div class='item-inner'>\
												<div class='item-title-row'>\
													<div class='item-title'>{{ title }}</div>\
													<div class='item-after'>{{ viewer }} - {{ publish }}</div>\
												</div>\
												<div class='item-text'>{{ content }}</div>\
											</div>\
										</a></div>\
									</li>"

					elementTemplate = Template(elementString);
					elementRendered = elementTemplate(post); 	

					newsWrapper.innerHTML += elementRendered;			
					elementString = "";
				});
			}
			if (nyanStorage.isAvailable('news')) {
				render(nyanStorage.get('news'));
			} else {
				var body = {
					deviceModel: deviceModel
				}
				var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), nyanStorage.get('apiKey')).toString()

				$$.ajax({
					url: baseUrl + 'news/latest',
					method: "POST",
					dataType: "json",
					timeout: timeoutAjax,
					headers: {
						Signature: hmac,
						Nonce: Date.now(),
						'x-app-version': appVersion,
						'x-device-id': deviceId,
					},
					data: body,
					success: function(data) {
						nyanStorage.put('news', data.results.news);
						nyanStorage.put('newsHash', data.results.newsHash);

						render(data.results.news);
					},
					error: Util.ajaxErrorCallback
				})
			}

			var ptrContent = $$(page.container).find('.pull-to-refresh-content');

			ptrContent.on('refresh', function(e) {
				var body = {
					deviceModel: deviceModel
				}
				var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), nyanStorage.get('apiKey')).toString()

				$$.ajax({
					url: baseUrl + 'news/latest',
					method: "POST",
					dataType: "json",
					timeout: timeoutAjax,
					headers: {
						Signature: hmac,
						Nonce: Date.now(),
						'x-app-version': appVersion,
						'x-device-id': deviceId,
					},
					data: body,
					success: function(data) {
						nyanStorage.put('news', data.results.news);
						nyanStorage.put('newsHash', data.results.newsHash);

						render(data.results.news);
					},
					error: Util.ajaxErrorCallback
				});

				myApp.pullToRefreshDone();
			});

			$$(page.container).find('.link-news').on('click', function(e) {
				var newsItem = JSON.parse(atob($$(this).data('news')));

				Events.open.news(newsItem)
			});
		},
		onInitDonate: function(page) {
			$$(page.container).find('#backButton').click(function () {
				mainView.router.back();
			});

			Util.trackEvent('onUserVisitDonate');

			$$(page.container).find('#bitcoinAddress').val(atob("MU1GV2diRXpwaWlnTmJqTW11TlBhYk15b0RtcnZUNmY4YQ=="));
			$$(page.container).find('#ethereumAddress').val(atob("MHhhNTA0ZTdhYmU1YTY5ZDYwNTlmODg0MDMzZmUzOGIzNTZhN2ExMjM5"));
			$$(page.container).find('#dogecoinAddress').val(atob("RFNad1dqQ2R2RUpZaHJuZDJzNzlVWVZYUm1raEZYclB2OQ=="));
			$$(page.container).find('#digibyteAddress').val(atob("REpMVVcyOVE0d0d3MXpMbXN3c2pHNGttamFLWFdzVlg1dg=="));
			$$(page.container).find('#litecoinAddress').val(atob("TFpqUGJWRG5hS2huN1BMMnpod3NuZGtWalRHRlNyZ3VNMw=="));
		}
	},
	tab: {
		faucet: {
			onShow: function() {
				refreshButton.hide();
			},
			onRefresh: function() {
				var profiles = nyanStorage.get('userProfile');
				var amountDollar;

				notifDOM.text(notifications[Math.floor(Math.random() * notifications.length)])

				if (profiles == null) {
					nyanStorage.clear();
					mainView.router.loadPage('login.html');
				} else {
					amountDollar = profiles.amount * nyanStorage.get('dollar');
					earningValueDollar.text("$ " + amountDollar.toFixed(7)); 
				}

				$$.ajax({
					url: baseUrl + "auth/active",
					method: "GET",
					dataType: "json",
					timeout: timeoutAjax,
					headers: {
						Token: nyanStorage.get('apiKey'),
						Key: nyanStorage.get('key'),
						'x-app-version': appVersion,
						'x-device-id': deviceId
					},
					success: function(res, status, xhr) {
						Util.trackEvent('onRefreshUser');

						if (res.status) {
							nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));

							nyanStorage.put('userProfile', res.results);
							nyanStorage.put('dollar', res.data.price);

							Profiles = res.results;

							var newsId = nyanStorage.get('newsHash');

							if (res.newsId !== newsId) {
								$$('i.icon-bars').html('<span class="badge bg-red">$</span>');
								$$('.newsListItem').append('<span class="badge bg-orange">NEW</span>');
							} else {
								$$('i.icon-bars').find('span').remove();
								$$('.newsListItem').find('span').remove();
							}

							Util.setProfile(res.results);
							clearTimeout(nyanStorage.get('timeoutId'));

							nyanStorage.put('minWd', res.data.minWithdrawal);
							nyanStorage.put('feeWd', res.data.feeWithdrawal);
							nyanStorage.put('referrals', res.referrals);

							wdMin.text(res.data.minWithdrawal);
							wdFee.text(res.data.feeWithdrawal);
							referralCounter.text(res.referrals);

							Util.seeTime();
							Util.showNotif("Time Synchronized", 3000);
						} else {
							Util.showNotif("Error Refresh Status", 3000);
						}
						myApp.pullToRefreshDone();
					},
					error: Util.ajaxErrorCallback
				})
			}
		},
		history: {
			data: {
				claimDOM: "<tr>\
							<td class=\"label-cell content-nowrap\">#{{ id }}</td>\
							<td class=\"label-cell content-nowrap\"><span class='color-green'>{{ amount }} Ð</span></td>\
							<td class=\"label-cell content-nowrap\">{{ onClaim }}</td>\
						 </tr>",
				withdrawalDOM: "<div class=\"accordion-list\">\
								<div class=\"withdrawal-item accordion-item content-block\">\
									<a href=\"#\" class=\"item-link\">\
										<div class=\"row big-font\">\
											<div class=\"col-50\">\
												<span>#{{ id }}</span>\
											</div>\
											<div class=\"col-50\" align=\"right\">\
												<span class='color-red'>-{{ amount }} Ð</span>\
											</div>\
										</div>\
										<span class=\"badge {{colorLabel}}\">{{ status }}</span>\
										<span class=\"badge bg-orange\">{{ level }}</span>\
										<div class=\"date-time\">\
											<i class=\"icon icon-time\"></i> {{ onSuccess }}\
										</div>\
									</a>\
									<div class=\"accordion-item-content\">\
										<div>\
											<span class=\"subtitle\">Address</span><br>\
											<span>{{ address }}</span>\
										</div>\
										<div>\
											<span class=\"subtitle\">Requested</span><br>\
											<span>{{ requestDate }}</span>\
										</div>\
										<div class='{{ isSuccess }}'>\
											<span class=\"subtitle\">TX</span><br>\
											<span class=\"txhash\">{{ txId }}</span>\
										</div>\
										<div class='{{ isCancel }}'>\
											<span class=\"subtitle\">Reason</span><br>\
											<span class=\"txhash\">{{ reason }}</span>\
										</div>\
									</div>\
								</div></div>"
			},
			onShow: function() {

				// Show Refresh Icon
				refreshButton.show();

				if (!historyRender) {
					myApp.pullToRefreshTrigger(historyView);
					historyRender = true;
				} 

				refreshButton.click(function(e) {
					myApp.pullToRefreshTrigger(historyView);
				});
			},
			onRefresh: function() {
				var withdrawalTable = document.getElementById('withdrawalTable');
				var avgReward = $$('#avgReward');

				var body = {
					deviceModel: deviceModel
				}
				var hmac = CryptoJS.HmacSHA256(JSON.stringify(body), nyanStorage.get('apiKey')).toString()

				// Reset
				// dataTable.innerHTML = "";
				withdrawalTable.innerHTML = "";
				$$.ajax({
					method: "POST",
					url: baseUrl + 'history/',
					dataType: 'json',
					timeout: timeoutAjax,
					headers: {
						Signature: hmac,
						Nonce: Date.now(),
						Token: nyanStorage.get('apiKey'),
						Key: nyanStorage.get('key'),
						'x-app-version': appVersion,
						'x-device-id': deviceId
					},
					data: body,
					success: function(datas, status, xhr) {
						Util.trackEvent('onRefreshHistory');

						nyanStorage.put('key', xhr.getResponseHeader('Access-Control-Key'));
						nyanStorage.put('historySource', datas.results);
						nyanStorage.put('referrals', datas.results.referrals);

						referralCounter.text(datas.results.referrals);
						avgReward.text(datas.results.rewards);

						// datas.results.user.forEach(function(data) {
						// 	elementString = Events.tab.history.data.claimDOM;
						// 	elementTemplate = Template(elementString);
						// 	elementRendered = elementTemplate(data);

						// 	dataTable.innerHTML += elementRendered;
						// });
						
						datas.results.withdrawal.forEach(function(data) {
							var isSuccess = (data.status == "Success");

							data.colorLabel = (isSuccess) ? "bg-green" : (data.status == "Canceled") ? "bg-red" : "bg-orange";
							data.txIdDisplay = (isSuccess) ? "<a>" + data.txId.substr(0, 30) + "...</a>" : "Not Avialable";
							data.showReason = (data.status == "Canceled") ? 'showReason' : 'hideReason';
							data.isSuccess = (isSuccess) ? "success" : "none";
							data.isCancel = (data.status == "Canceled");
							data.requestDate = new Date(data.onSubmit).toLocaleString();

							elementString = Events.tab.history.data.withdrawalDOM;
							elementTemplate = Template(elementString);
							elementRendered = elementTemplate(data);

							withdrawalTable.innerHTML += elementRendered;
						});

						if (datas.results.withdrawal.length == 0) {
							withdrawalTable.innerHTML = "<div class='content-block-title' style='padding: 0;'>No data</div>";
						}

						myApp.pullToRefreshDone();
					},
					error: Util.ajaxErrorCallback
				});
			}
		},
		withdrawal: {
			onShow: function() {
				refreshButton.hide();

				var timeoutId = true;
				$$('#amountWd').on('keyup', (function() {
					if (timeoutId) {
						window.clearTimeout(timeoutId);

						timeoutId = window.setTimeout(function() {
							var thisVal = $$('#amountWd').val();
							var wdLevelSelected = selectWithdrawalLevel.text();
							var feeWdVal = wdLevel[wdLevelSelected.toLowerCase()];

							$$('#estimatedReceived').val((thisVal * 1) - feeWdVal);
						}, 500);
					}
				}));
				var profile = nyanStorage.get('userProfile');

				var minWd = nyanStorage.get('minWd');
				var progress = ((profile.amount * 1) / minWd) * 100;
				var progressbar = $$('.progressbar-inline .progressbar');
				
				myApp.setProgressbar(progressbar, progress);
				$$('#percentValue').text(progress.toFixed(2) + "%");
				if (progress > 100) {
					$$('#percentValue').addClass('luweh');
				}
			}
		}
	}
}
var Template = function(text) {
	var noMatch = /(.)^/;
	var settings = {
		interpolate : /\{\{(.+?)\}\}/g
	};
	var escaper = /\\|'|\r|\n|\u2028|\u2029/g;
	var escapes = {
		"'":      "'",
		'\\':     '\\',
		'\r':     'r',
		'\n':     'n',
		'\u2028': 'u2028',
		'\u2029': 'u2029'
	};
	var escapeChar = function(match) {
		return '\\' + escapes[match];
	};

	// Combine delimiters into one regular expression via alternation.
	var matcher = RegExp([
		(settings.escape || noMatch).source,
		(settings.interpolate || noMatch).source,
		(settings.evaluate || noMatch).source
	].join('|') + '|$', 'g');

	// Compile the template source, escaping string literals appropriately.
	var index = 0;
	var source = "__p+='";
	text.replace(matcher, function(match, escape, interpolate, evaluate, offset) {
		source += text.slice(index, offset).replace(escaper, escapeChar);
		index = offset + match.length;

		if (escape) {
			source += "'+\n((__t=(" + escape + "))==null?'':_.escape(__t))+\n'";
		} else if (interpolate) {
			source += "'+\n((__t=(" + interpolate + "))==null?'':__t)+\n'";
		} else if (evaluate) {
			source += "';\n" + evaluate + "\n__p+='";
		}

		// Adobe VMs need the match returned to produce the correct offest.
		return match;
	});
	source += "';\n";

	// If a variable is not specified, place data values in local scope.
	if (!settings.variable) source = 'with(obj||{}){\n' + source + '}\n';

	source = "var __t,__p='',__j=Array.prototype.join," +
		"print=function(){__p+=__j.call(arguments,'');};\n" +
		source + 'return __p;\n';

	try {
		var render = new Function(settings.variable || 'obj', '_', source);
	} catch (e) {
		e.source = source;
		throw e;
	}

	var template = function(data) {
		return render.call(this, data);
	};

	// Provide the compiled source as a convenience for precompilation.
	var argument = settings.variable || 'obj';
		template.source = 'function(' + argument + '){\n' + source + '}';

	return template;
};
var Util = {
	countdown: function(minutes, seconds) {
		var mins = minutes;

		function tick() {
			var counter = $$('#doClaim');
			var current_minutes = mins-1
			seconds--;
			
			counter.text(current_minutes.toString() + ":" + (seconds < 10 ? "0" : "") + String(seconds));
			if (seconds > 0) {
				var timeoutId = setTimeout(tick, 1000);
				nyanStorage.put('timeoutId', timeoutId);
			} else {
				if(mins > 1){
					Util.countdown(mins-1, 60);           
				}
			}
			if (seconds == 0 && mins == 1) {
				countDownStop = true;
				Util.readyToClaim();
			} 
		}
		tick();
	},
	setProfile: function(profile) {
		$$('#addressInput').val(profile.address);

		earningValue.text((profile.amount * 1).toFixed(4) + " Ð");
		referralCode.text(profile.referral);
		earningRefValue.text(profile.amountRef + " Ð");
		referralCounter.text(nyanStorage.get('referrals'));
		addressDogecoin.text(profile.address.substr(0, 16) + '...');

		Util.renderPrice();
	},
	getTimeDiff: function(date) {
		var today = new Date();
		var newDate = new Date(date);

		return Math.floor((today.getTime() - newDate.getTime()) / 1000);
	},
	showNotif: function(message, timeout) {
		var notifAdded = myApp.addNotification({
			message: message
		});

		setTimeout(function() {
			myApp.closeNotification(notifAdded);
		}, timeout);

		return false;
	},
	readyToClaim: function() {
		buttonClaim.removeClass("disabled");
		buttonClaim.text("Claim");

		nyanStorage.put('claim', true);
		nyanStorage.remove('startClaim');

		Util.showNotif('Now, Faucet ready to claim!', 5000);
	},
	ajaxErrorCallback: function(data) {
		var statusCode = data.status;	

		if (statusCode !== 200 || data.statusText !== "OK") {	
			switch(statusCode) {
				case 401:
					mainView.router.loadPage('login.html');

					Util.showNotif("Sorry, please login again!", 6000);
					break;
				default:
					if (data.statusText) {
						Util.showNotif(data.statusText, 3000);
					} else {
						try {
							window.ga.trackException('onAjaxError', true);
						} catch(e) {
							App.log('trackException is not founds');
						}

						Util.showNotif("Sorry, we are can't connect to Server. Pelase try again later", 3000);
					}
					break;
			}
		}

		myApp.hidePreloader();
		myApp.hideIndicator();
		myApp.pullToRefreshDone();
	},
	seeTime: function() {
		if (!nyanStorage.isAvailable('startClaim')) {
			buttonClaim.removeClass('disabled');
			buttonClaim.text('Claim');
		} else {
			buttonClaim.addClass('disabled');

			var startClaim = nyanStorage.get('startClaim');
			var diffClaim = (4 * 60) - Util.getTimeDiff(startClaim);

			if (diffClaim < 0) {
				buttonClaim.removeClass('disabled');
				buttonClaim.text('Claim');
			} else {
				var minutes = Math.floor(diffClaim / 60);
				var seconds = diffClaim - minutes * 60;

				Util.countdown((minutes + 1), seconds);
			}
		}
	},
	renderPrice: function(price) {
		var amountDollar;

		if (typeof price === "undefined") {
			amountDollar = Profiles.amount * nyanStorage.get('dollar');

			earningValueDollar.text("$ " + amountDollar.toFixed(7)); 
		} else {
			amountDollar = Profiles.amount * price;
			
			earningValueDollar.text("$ " + amountDollar.toFixed(7)); 
		}
	},
	trackEvent: function(eventName) {
		try {
			window.ga.trackEvent('Apps', eventName, 'Hits', 1);
		} catch(e) {
			App.log('event tract error ' + eventName);
		}
	},
	bannedCallback: function() {
		myApp.confirm("Sorry, your account has banned automatically by Systems. Please fill this form to Appeal. Select 'OK' to copy form url.", function() {
			window.cordova.plugins.clipboard.copy(appealUrl, function() {
				myApp.alert("Url already copy to clipboard");
			}, function() {
				myApp.alert("Ow no, we can't copy the url into clipboard. Write this manualy, '" + appealUrl + "'");
			});
		});
	}
}
/**	
 * Ajax Events 
 */
$$(document).on('ajaxStart', Events.onAjaxDetected);
$$(document).on('ajaxComplete', Events.onAjaxDetected);

/**	
 * Panel Events
 */
$$('.panel-left').on('close', Events.panel.onClose);
$$('.panel-left').on('open', Events.panel.onOpen);

/**	
 * Button Events
 */
buttonClaim.on('click', Events.button.onClickClaim);
doWithdrawalButton.on('click', Events.button.onClickWithdrawal);
boxToggle.on('click', Events.button.onClickBoxToggle);
selectWithdrawalLevel.on('click', Events.button.onClickSelectWithdrawalLevel)

/**	
 * Page Events
 */
myApp.onPageInit('login', Events.page.onInitLogin);
myApp.onPageInit('news', Events.page.onInitNews);
myApp.onPageInit('donateView', Events.page.onInitDonate);

/**	
 * Tabs Events
 */
faucetView.on('tab:show', Events.tab.faucet.onShow);
faucetView.on('ptr:refresh', Events.tab.faucet.onRefresh);
historyView.on('tab:show', Events.tab.history.onShow);
historyView.on('ptr:refresh', Events.tab.history.onRefresh);
withdrawalView.on('tab:show', Events.tab.withdrawal.onShow);

/**
 * Event Want Push to Analytics
 */
document.addEventListener('onAdFailLoad', function(e) {
	/**	Push analytics onAdFailLoad */
	window.ga.trackEvent('Apps', 'onAdFailLoad', 'Fail', 1); 
});
document.addEventListener('onAdPresent', function(e) {
	/** Push analytics onAdPresent */
	window.ga.trackEvent('Apps', 'onAdPresent', 'Hits', 1); 
});

$$(document).on('click', '.card-account', function(e) {
	$$('.card-account').forEach(function(item) {
		$$(item).removeClass('selected');
		$$(item).parent().parent().removeClass('selected')
	});

	$$(this).toggleClass('selected');
	$$(this).parent().parent().toggleClass('selected');

	var address = $$(this).attr('data-address');
		loginData.address = address;

	App.log(loginData);
});

//fire event on app loaded
Events.onLoad();
